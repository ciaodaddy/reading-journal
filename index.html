<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Reading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <style>
        :root {
            --paper-bg: #fdfaf3;
            --ink-black: #1a1a1a;
            --accent-gold: #9b7e46;
            --border-color: #dcd9d0;
        }
        html, body {
            background-color: var(--paper-bg);
            color: var(--ink-black);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            height: auto;
            scroll-behavior: smooth;
        }
        .crimson { font-family: 'Crimson Pro', serif; }
        .shimmer { 
            background: linear-gradient(90deg, #fdfaf3 25%, #f5f1e8 50%, #fdfaf3 75%); 
            background-size: 200% 100%; 
            animation: shim 2s infinite linear; 
        }
        @keyframes shim { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #dcd9d0; border-radius: 10px; }
        
        .journal-frame { 
            border: 1px solid var(--border-color);
            padding: 12px;
            background: #fff;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: inline-block;
            width: auto;
            max-width: 100%;
        }
        
        .accent-text { color: var(--accent-gold); }
        img.sketch-content { 
            display: block; 
            width: auto;
            max-width: 100%;
            max-height: 280px; 
            height: auto;
            object-fit: contain;
            border: 1px solid #eee;
            margin: 0 auto;
        }
        
        .mini-frame .journal-frame {
            padding: 6px;
        }
        .mini-frame img.sketch-content {
            max-height: 140px;
        }

        .prose p { margin-bottom: 1.5em; }
        .prose strong { font-weight: 700; color: #000; }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc, getDocs, getDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- CONFIGURATION ---
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAj8BIwFHJ-VrOZFeGPRgUF1LSeI03iHzI",
            authDomain: "book-listing-web-app.firebaseapp.com",
            projectId: "book-listing-web-app",
            storageBucket: "book-listing-web-app.firebasestorage.app",
            messagingSenderId: "475203413153",
            appId: "1:475203413153:web:ab0dfd7246ea274fd1bce0",
            measurementId: "G-0Z5HESVLP5"
        };

        const GEMINI_API_KEY = "AIzaSyCZuPrskD5WDVA0R51RAe2bv4hdg6yn82I";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        const callGemini = async (promptText) => {
            const activeKey = (typeof __gemini_api_key !== 'undefined' && __gemini_api_key) ? __gemini_api_key : GEMINI_API_KEY;
            const res = await fetchWithRetry(
                `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${activeKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                }
            );
            return res.candidates[0].content.parts[0].text;
        };

        // Standardized lists
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const BOOK_CLASSIFICATIONS = [
            "Literary Fiction", "Historical Fiction", "Sci-Fi / Fantasy", "Mystery / Thriller",
            "Memoir / Biography", "History / Politics", "Philosophy / Religion", "Science / Nature",
            "Essays / Poetry", "Current Affairs"
        ];
        const STANDARDIZED_QUESTIONS = [
            "How did your current physical or mental environment bleed into your interpretation of this book?",
            "What specific stylistic choice or 'fingerprint' by the author felt most distinct or jarring?",
            "Which single image or line is currently stuck in your mind, and why do you think it's the one that stayed?",
            "If you had to describe the 'texture' of this book (e.g., sharp, hazy, dense, clinical, warm), what would it be?",
            "At what point in the story did your initial expectation shift most dramatically?",
            "What specific curiosity does this leave you with for your next read?"
        ];

        // --- ICONS ---
        const Icon = ({ name, size = 18, className = "", fill = "none" }) => {
            const icons = {
                "star": <path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
                "book-plus": <><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" /><path d="M9 10h6" /><path d="M12 7v6" /></>,
                "sparkles": <><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M3 5h4" /><path d="M21 17v4" /><path d="M19 19h4" /></>,
                "search": <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
                "trash-2": <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
                "edit-3": <><path d="M12 20h9" /><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" /></>,
                "calendar": <><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></>,
                "upload": <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>,
                "rotate-cw": <><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><polyline points="21 3 21 8 16 8" /></>,
                "book-marked": <><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" /><polyline points="10 2 10 10 13 7 16 10 16 2" /></>,
                "x": <><line x1="18" x2="6" y1="6" y2="18" /><line x1="6" x2="18" y1="6" y2="18" /></>,
                "send": <><line x1="22" x2="11" y1="2" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>,
                "save": <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
                "alert-triangle": <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></>,
                "grip-vertical": <><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></>,
                "arrow-up": <path d="m5 12 7-7 7 7M12 19V5" />,
                "arrow-down": <path d="m19 12-7 7-7-7M12 5v14" />,
                "tag": <><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" /><line x1="7" x2="7.01" y1="7" y2="7" /></>,
                "download": <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
                "plus": <><line x1="12" x2="12" y1="5" y2="19" /><line x1="5" x2="19" y1="12" y2="12" /></>,
                "book-open": <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                "check": <polyline points="20 6 9 17 4 12" />,
                "undo": <path d="M3 7v6h6M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />,
                "users": <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
                "lock": <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
                "key": <><path d="m21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></>,
                "eye": <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
                "eye-off": <><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- UTILS ---
        const fetchWithRetry = async (url, options, maxRetries = 3) => {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status >= 400 && response.status < 500) {
                        const errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            throw new Error(errorJson.error?.message || `Client Error ${response.status}`);
                        } catch {
                            throw new Error(`API Error: ${errorText}`);
                        }
                    }
                    if (response.ok) return await response.json();
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("Connection Timeout");
        };

        const compressImage = (base64Str) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let targetWidth = img.width;
                    let targetHeight = img.height;
                    const maxDim = 1000;
                    if (targetWidth > maxDim || targetHeight > maxDim) {
                        if (targetWidth > targetHeight) {
                            targetHeight = Math.round((targetHeight * maxDim) / targetWidth);
                            targetWidth = maxDim;
                        } else {
                            targetWidth = Math.round((targetWidth * maxDim) / targetHeight);
                            targetHeight = maxDim;
                        }
                    }
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = base64Str;
            });
        };

        const fetchAndCompressImageUrl = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    const maxDim = 1000;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round((h * maxDim) / w); w = maxDim; }
                        else { w = Math.round((w * maxDim) / h); h = maxDim; }
                    }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.onerror = () => reject(new Error("Failed to load cover image"));
                img.src = url;
            });
        };

        const generatePlaceholderCover = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 400; 
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fdfaf3'; 
            ctx.fillRect(0, 0, 400, 600);
            const gradient = ctx.createLinearGradient(0, 0, 400, 600);
            gradient.addColorStop(0, 'rgba(255,255,255,0.6)');
            gradient.addColorStop(1, 'rgba(240,230,210,0.3)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,400,600);
            ctx.strokeStyle = '#9b7e46'; 
            ctx.lineWidth = 12;
            ctx.strokeRect(20, 20, 360, 560);
            ctx.strokeStyle = '#dcd9d0'; 
            ctx.lineWidth = 2;
            ctx.strokeRect(30, 30, 340, 540);
            const cx = 200;
            const cy = 300;
            ctx.beginPath();
            ctx.arc(cx, cy, 80, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(220, 217, 208, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(cx, cy - 120);
            ctx.lineTo(cx + 80, cy);
            ctx.lineTo(cx, cy + 120);
            ctx.lineTo(cx - 80, cy);
            ctx.lineTo(cx, cy - 120);
            ctx.closePath();
            ctx.strokeStyle = '#9b7e46';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = 'rgba(155, 126, 70, 0.05)';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx, cy, 6, 0, 2 * Math.PI);
            ctx.fillStyle = '#9b7e46';
            ctx.fill();
            return canvas.toDataURL('image/jpeg', 0.85);
        };

        // --- LANDING PAGE / LOBBY ---
        function LandingPage({ onEnter, db }) {
            const [handle, setHandle] = useState("");
            const [key, setKey] = useState("");
            const [showKey, setShowKey] = useState(false);
            const [existingUsers, setExistingUsers] = useState([]);
            const [userExists, setUserExists] = useState(null); 

            useEffect(() => {
                const init = async () => {
                    if (!db) return;
                    const { collection, getDocs } = window.FirebaseSDK;
                    try {
                        const snap = await getDocs(collection(db, 'artifacts', 'reading-journal-2026', 'users'));
                        const users = snap.docs.map(d => d.id);
                        setExistingUsers(users);
                    } catch (e) {
                        console.error("Could not fetch users", e);
                    }
                };
                init();
            }, [db]);

            useEffect(() => {
                if (!handle) {
                    setUserExists(null);
                    return;
                }
                const cleanHandle = handle.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (existingUsers.includes(cleanHandle)) {
                    setUserExists(true);
                } else {
                    setUserExists(false);
                }
            }, [handle, existingUsers]);

            const handleGo = () => {
                if(!handle) return;
                const cleanHandle = handle.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (userExists === false && !key) {
                    alert("To create a NEW journal, you must set a Secret Key so you can edit it later!");
                    return;
                }
                
                onEnter(cleanHandle, key);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white max-w-md w-full p-8 border border-[#dcd9d0] shadow-xl text-center">
                        <h1 className="crimson text-4xl font-bold mb-2">Reading Journal</h1>
                        <p className="text-gray-500 italic mb-8 crimson">A shared space for literary memory.</p>
                        
                        <div className="space-y-4">
                            <div className="text-left">
                                <label className="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-1">
                                    Your Handle (Name)
                                </label>
                                <input 
                                    type="text" 
                                    value={handle} 
                                    onChange={e => setHandle(e.target.value)} 
                                    className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 outline-none focus:border-[#9b7e46]"
                                    placeholder="e.g. robert"
                                />
                                {handle && userExists === true && (
                                    <p className="text-[10px] text-green-600 mt-1 font-bold">● Found existing journal</p>
                                )}
                                {handle && userExists === false && (
                                    <p className="text-[10px] text-[#9b7e46] mt-1 font-bold">● Creating new journal</p>
                                )}
                            </div>

                            <div className="text-left relative">
                                <label className="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-1">
                                    Secret Key {userExists === true ? "(Leave blank to Read-Only)" : "(Required for new journal)"}
                                </label>
                                <div className="relative">
                                    <input 
                                        type={showKey ? "text" : "password"} 
                                        value={key} 
                                        onChange={e => setKey(e.target.value)} 
                                        className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 pr-10 outline-none focus:border-[#9b7e46]"
                                        placeholder={userExists === false ? "Create a password..." : "Enter key to edit..."}
                                    />
                                    <button 
                                        type="button"
                                        onClick={() => setShowKey(!showKey)} 
                                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-black transition-colors"
                                        title={showKey ? "Hide key" : "Show key"}
                                    >
                                        <Icon name={showKey ? "eye-off" : "eye"} size={16} />
                                    </button>
                                </div>
                            </div>

                            <button onClick={handleGo} className="w-full bg-[#1a1a1a] text-white py-3 font-bold uppercase text-xs tracking-widest hover:bg-[#9b7e46] transition-colors">
                                {userExists === false ? "Create Journal" : "Enter Journal"}
                            </button>
                        </div>

                        {existingUsers.length > 0 && (
                            <div className="mt-8 pt-8 border-t border-[#dcd9d0]">
                                <h3 className="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">Browsing Library</h3>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {existingUsers.map(u => (
                                        <button key={u} onClick={() => setHandle(u)} className="bg-gray-100 hover:bg-[#fdfaf3] border border-transparent hover:border-[#dcd9d0] px-3 py-1 rounded text-xs text-gray-600 transition-colors">
                                            {u}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- MAIN APP COMPONENT ---
        function JournalApp({ userHandle, secretKey, db, currentUser }) {
            // AUTH / USER STATE
            const [isReadOnly, setIsReadOnly] = useState(true);

            // APP DATA STATE
            const [books, setBooks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [isSearchOpen, setIsSearchOpen] = useState(false);
            const [errorMessage, setErrorMessage] = useState(null);
            
            // EDITING / MODALS
            const [isAddOpen, setIsAddOpen] = useState(false);
            const [newBook, setNewBook] = useState({ 
                title: '', 
                author: '', 
                monthFinished: MONTHS[new Date().getMonth()], 
                rating: 5, 
                classification: BOOK_CLASSIFICATIONS[0],
                status: 'finished'
            });
            const [isInterviewOpen, setIsInterviewOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [editingBook, setEditingBook] = useState(null);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [activeBook, setActiveBook] = useState(null); 
            const [answers, setAnswers] = useState({});
            const [isGenerating, setIsGenerating] = useState(false);
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [generatingImageId, setGeneratingImageId] = useState(null);
            
            const fileInputRef = useRef(null);
            const searchInputRef = useRef(null);
            const defaultGeometricArt = useMemo(() => generatePlaceholderCover(), []);

            // --- PERMISSION CHECK LOGIC ---
            useEffect(() => {
                const checkPermissions = async () => {
                    const { doc, setDoc, getDoc } = window.FirebaseSDK;
                    if (!db || !currentUser) return;

                    const userDocRef = doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle);
                    
                    try {
                        const userSnap = await getDoc(userDocRef);
                        
                        if (!userSnap.exists()) {
                            // NEW USER LOGIC
                            if (secretKey) {
                                await setDoc(userDocRef, { secretKey: secretKey, createdAt: Date.now() });
                                setIsReadOnly(false);
                            } else {
                                setIsReadOnly(true);
                            }
                        } else {
                            // EXISTING USER LOGIC
                            const data = userSnap.data();
                            if (data.secretKey === secretKey) {
                                setIsReadOnly(false);
                            } else {
                                setIsReadOnly(true);
                            }
                        }
                    } catch (e) {
                        console.error("Permission check failed", e);
                        // If checking permission fails, default to read-only but don't hang
                        setIsReadOnly(true);
                    }
                };
                checkPermissions();
            }, [userHandle, secretKey, db, currentUser]); 

            // Focus search
            useEffect(() => {
                if (isSearchOpen && searchInputRef.current) searchInputRef.current.focus();
            }, [isSearchOpen]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!db || !currentUser) return;
                const { collection, onSnapshot } = window.FirebaseSDK;
                const booksCol = collection(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books');
                
                const unsubscribe = onSnapshot(booksCol, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBooks(data.sort((a, b) => (a.order ?? 0) - (b.order ?? 0) || b.updatedAt - a.updatedAt));
                    setLoading(false);
                    setErrorMessage(null);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    setErrorMessage("Unable to load journal data. Check connection.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, currentUser, userHandle]);

            // --- DERIVED STATE ---
            const { currentReads, finishedBooks } = useMemo(() => {
                const current = books.filter(b => b.status === 'reading');
                const finished = books.filter(b => b.status !== 'reading');
                return { currentReads: current, finishedBooks: finished };
            }, [books]);

            const filteredFinishedBooks = useMemo(() => {
                const term = searchTerm.toLowerCase();
                if (!term) return finishedBooks;
                return finishedBooks.filter(b => 
                    (b.title || "").toLowerCase().includes(term) || 
                    (b.author || "").toLowerCase().includes(term) ||
                    (b.tag || "").toLowerCase().includes(term) ||
                    (b.classification || "").toLowerCase().includes(term)
                );
            }, [finishedBooks, searchTerm]);

            const stats = useMemo(() => {
                const total = finishedBooks.length;
                if (total === 0) return null;
                const avgRating = (finishedBooks.reduce((acc, b) => acc + (b.rating || 0), 0) / total).toFixed(1);
                return { total, avgRating };
            }, [finishedBooks]);

            // --- ACTIONS (Only work if !isReadOnly, but UI hides them anyway) ---
            const getCollectionRef = () => {
                const { collection } = window.FirebaseSDK;
                return collection(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books');
            }

            const handleAddBook = async (e) => {
                e.preventDefault();
                if (isReadOnly) return;
                const { addDoc } = window.FirebaseSDK;
                const nextOrder = books.length > 0 ? Math.max(...books.map(b => b.order ?? 0)) + 1 : 0;
                
                if (newBook.status === 'reading') {
                    try {
                        await addDoc(getCollectionRef(), { 
                            ...newBook, imageUrl: defaultGeometricArt, year: "2026", updatedAt: Date.now(), order: nextOrder 
                        });
                        setNewBook({ title: '', author: '', monthFinished: MONTHS[new Date().getMonth()], rating: 5, classification: BOOK_CLASSIFICATIONS[0], status: 'finished' });
                        setIsAddOpen(false);
                    } catch (e) { setErrorMessage("Failed to add book."); }
                } else {
                    setActiveBook({...newBook, imageUrl: defaultGeometricArt}); 
                    setAnswers({}); 
                    setCurrentQuestionIdx(0); 
                    setIsInterviewOpen(true);
                }
            };

            const saveNewOrder = async (reordered) => {
                if (isReadOnly) return;
                const { doc, updateDoc } = window.FirebaseSDK;
                try {
                    await Promise.all(reordered.map((b, i) => 
                        updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', b.id), { order: i })
                    ));
                } catch (e) { console.error("Reorder failed", e); }
            };

            const moveUp = (idx) => {
                if (isReadOnly || idx === 0) return;
                const reordered = [...finishedBooks];
                [reordered[idx], reordered[idx-1]] = [reordered[idx-1], reordered[idx]];
                saveNewOrder(reordered);
            };

            const moveDown = (idx) => {
                if (isReadOnly || idx === finishedBooks.length - 1) return;
                const reordered = [...finishedBooks];
                [reordered[idx], reordered[idx+1]] = [reordered[idx+1], reordered[idx]];
                saveNewOrder(reordered);
            };

            const onFileChange = async (e) => {
                if (isReadOnly) return;
                const file = e.target.files[0];
                if (!file || !activeBook || !db) return;
                const { doc, updateDoc } = window.FirebaseSDK;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const compressed = await compressImage(event.target.result);
                        await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', activeBook.id), { imageUrl: compressed, updatedAt: Date.now() });
                    } catch (err) { setErrorMessage("Image processing failed."); }
                    finally { setActiveBook(null); }
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const handleUpdateEntry = async (e) => {
                e.preventDefault();
                if (isReadOnly) return;
                const { doc, updateDoc } = window.FirebaseSDK;
                try {
                    await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', editingBook.id), { ...editingBook, updatedAt: Date.now() });
                    setEditingId(null); setEditingBook(null);
                } catch (err) { setErrorMessage("Update failed."); }
            };

            const handleRemoveEntry = async (id) => {
                if (isReadOnly) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                try {
                    await deleteDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', id));
                    setDeleteConfirmId(null);
                } catch (err) {}
            };

            const handleFetchCover = async (bookData) => {
                if (isReadOnly) return;
                const { doc, updateDoc } = window.FirebaseSDK;
                setGeneratingImageId(bookData.id);
                try {
                    const q = encodeURIComponent(`intitle:${bookData.title} inauthor:${bookData.author}`);
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);
                    const data = await response.json();
                    if (data.items && data.items[0]?.volumeInfo?.imageLinks) {
                        const links = data.items[0].volumeInfo.imageLinks;
                        let imgUrl = links.extraLarge || links.large || links.medium || links.thumbnail || links.smallThumbnail;
                        if (imgUrl.startsWith('http:')) imgUrl = imgUrl.replace('http:', 'https:');
                        imgUrl = imgUrl.replace('&edge=curl', '');
                        try {
                            const compressed = await fetchAndCompressImageUrl(imgUrl);
                            await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', bookData.id), { imageUrl: compressed, updatedAt: Date.now() });
                        } catch (compressErr) {
                            await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', bookData.id), { imageUrl: imgUrl, updatedAt: Date.now() });
                        }
                    } else {
                        await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', bookData.id), { imageUrl: defaultGeometricArt, updatedAt: Date.now() });
                    }
                } catch (e) { 
                    try { await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', bookData.id), { imageUrl: defaultGeometricArt, updatedAt: Date.now() }); } catch (err) {}
                } finally { setGeneratingImageId(null); }
            };

            const handleRevertCover = async (bookData) => {
                if (isReadOnly) return;
                const { doc, updateDoc } = window.FirebaseSDK;
                try { await updateDoc(doc(db, 'artifacts', 'reading-journal-2026', 'users', userHandle, 'books', bookData.id), { imageUrl: defaultGeometricArt, updatedAt: Date.now() }); } catch (e) {}
            };

            const finalizeReview = async () => {
                setIsGenerating(true);
                const { addDoc } = window.FirebaseSDK;
                const dataStr = STANDARDIZED_QUESTIONS.map((q, i) => `Q: ${q}\nA: ${answers[i] || 'N/A'}`).join('\n\n');
                try {
                    const review = await callGemini(`Synthesize a narrative reading journal entry for "${activeBook.title}" by ${activeBook.author}. Focus on uniquely specific reflections based on these notes:\n\n${dataStr}\n\nWord Count: 200-250 words. START DIRECTLY with narrative content. No headers.`);
                    const tagRaw = await callGemini(`Provide a punchy 2-4 word atmospheric tag for: ${review}`);
                    const tag = tagRaw.replace(/[".]/g, '').trim();
                    const nextOrder = books.length > 0 ? Math.max(...books.map(b => b.order ?? 0)) + 1 : 0;
                    
                    await addDoc(getCollectionRef(), { ...activeBook, review, tag, year: "2026", updatedAt: Date.now(), order: nextOrder });
                    setIsInterviewOpen(false);
                    setNewBook({ title: '', author: '', monthFinished: MONTHS[new Date().getMonth()], rating: 5, classification: BOOK_CLASSIFICATIONS[0], status: 'finished' });
                } catch (e) { setErrorMessage(`Synthesis failed: ${e.message}`); } 
                finally { setIsGenerating(false); setActiveBook(null); }
            };

            const handleExportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(books, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `reading_journal_${userHandle}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };
            
            // --- SHARE LINK ---
            const copyShareLink = () => {
                const url = window.location.origin + window.location.pathname + "?user=" + userHandle;
                navigator.clipboard.writeText(url);
                alert("Read-Only link copied to clipboard!");
            }

            return (
                <div className="min-h-screen py-10 px-4 pb-32 text-ink-black relative">
                    {/* TOP BAR */}
                    <div className="fixed top-0 left-0 right-0 p-2 flex justify-between items-start z-40 pointer-events-none">
                         <div className="pointer-events-auto bg-white/80 backdrop-blur p-2 border border-[#dcd9d0] rounded text-xs flex gap-2">
                             <span className="font-bold uppercase tracking-widest text-[#9b7e46]">{userHandle}</span>
                             {isReadOnly ? <Icon name="lock" size={14} className="text-gray-400"/> : <Icon name="key" size={14} className="text-green-600"/>}
                         </div>
                         <div className="pointer-events-auto flex gap-2">
                             <a href="/" className="bg-white/80 backdrop-blur p-2 border border-[#dcd9d0] rounded text-xs font-bold hover:bg-[#1a1a1a] hover:text-white transition-colors" title="Go to Lobby">Lobby</a>
                             <button onClick={copyShareLink} className="bg-white/80 backdrop-blur p-2 border border-[#dcd9d0] rounded text-xs font-bold hover:bg-[#1a1a1a] hover:text-white transition-colors">Share View</button>
                         </div>
                    </div>

                    <div className="max-w-2xl mx-auto mt-8">
                        <header className="text-center border-b border-[#1a1a1a] pb-8 mb-10">
                            <h1 className="crimson text-4xl md:text-5xl font-bold tracking-tight">2026 Reading Journal</h1>
                            <p className="crimson italic text-lg text-gray-600 mt-2">Classified memory anchors for the literary journey.</p>
                            
                            {stats && (
                                <div className="flex justify-center gap-12 mt-6 text-xs font-bold uppercase tracking-widest text-[#9b7e46]">
                                    <div className="flex flex-col items-center"><span className="text-2xl text-black font-normal crimson">{stats.total}</span><span>Finished</span></div>
                                    <div className="flex flex-col items-center"><span className="text-2xl text-black font-normal crimson">{stats.avgRating}</span><span>Avg Rating</span></div>
                                </div>
                            )}
                        </header>

                        {/* CURRENTLY READING */}
                        {currentReads.length > 0 && (
                            <section className="mb-12 animate-fade-in">
                                <h3 className="text-center text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 flex items-center justify-center gap-4">
                                    <span className="h-px bg-[#dcd9d0] w-12"></span> CURRENTLY READING <span className="h-px bg-[#dcd9d0] w-12"></span>
                                </h3>
                                <div className="grid grid-cols-1 gap-4">
                                    {currentReads.map(book => (
                                        <div key={book.id} className="bg-white border-l-4 border-[#9b7e46] p-6 shadow-sm flex items-start gap-6">
                                            <div className="shrink-0 w-24 group relative mini-frame">
                                                <div className="journal-frame flex items-center justify-center bg-[#fdfaf3]">
                                                    <img src={book.imageUrl || defaultGeometricArt} alt="Cover" className="sketch-content" />
                                                    {!isReadOnly && (
                                                        <div className="absolute inset-0 bg-white/95 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-1 p-1">
                                                            <button onClick={() => { setActiveBook({ id: book.id }); fileInputRef.current.click(); }} className="text-black hover:text-[#9b7e46] transition-colors"><Icon name="upload" size={14} /></button>
                                                            <button onClick={() => handleFetchCover(book)} disabled={generatingImageId === book.id} className="text-black hover:text-[#9b7e46] transition-colors">
                                                                {generatingImageId === book.id ? <div className="animate-spin h-3 w-3 border border-black border-t-transparent rounded-full" /> : <Icon name="search" size={14} />}
                                                            </button>
                                                            <button onClick={() => handleRevertCover(book)} className="text-gray-400 hover:text-black transition-colors"><Icon name="undo" size={14} /></button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex-1">
                                                <h4 className="crimson text-2xl font-bold leading-none mb-1">{book.title}</h4>
                                                <p className="text-xs uppercase tracking-widest text-gray-500 font-bold">{book.author}</p>
                                                <div className="mt-2 text-[10px] text-gray-400 font-bold uppercase">{book.classification}</div>
                                            </div>
                                            {!isReadOnly && (
                                                <div className="flex flex-col gap-2 shrink-0">
                                                    <button onClick={() => { setEditingId(book.id); setEditingBook({...book}); }} className="text-gray-300 hover:text-[#9b7e46] transition-colors"><Icon name="edit-3" size={16} /></button>
                                                    <button onClick={() => { setEditingId(book.id); setEditingBook({...book, status: 'finished', monthFinished: MONTHS[new Date().getMonth()], rating: 5 }); }} className="text-gray-300 hover:text-green-600 transition-colors"><Icon name="check" size={16} /></button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* SEARCH */}
                        {finishedBooks.length > 0 && (
                            <div className="mb-8 flex justify-center">
                                {!isSearchOpen ? (
                                    <button onClick={() => setIsSearchOpen(true)} className="text-gray-300 hover:text-[#9b7e46] transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-widest">
                                        <Icon name="search" size={14} /> Search Journal
                                    </button>
                                ) : (
                                    <div className="w-full max-w-md animate-fade-in relative">
                                        <Icon name="search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-300" />
                                        <input ref={searchInputRef} type="text" placeholder="Search..." className="w-full bg-white border border-[#dcd9d0] pl-10 pr-10 py-3 text-sm focus:border-[#9b7e46] outline-none transition-colors crimson" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        <button onClick={() => { setSearchTerm(''); setIsSearchOpen(false); }} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-black transition-colors"><Icon name="x" size={14} /></button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* INDEX */}
                        {filteredFinishedBooks.length > 0 && !searchTerm && (
                            <section className="mb-12 bg-[#f8f5ed] p-8 rounded-sm border border-[#eeebe2]">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-[#dcd9d0] pb-2">Journal Index</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                                    {MONTHS.map(month => {
                                        const booksInMonth = filteredFinishedBooks.filter(b => b.monthFinished === month);
                                        if (booksInMonth.length === 0) return null;
                                        return (
                                            <div key={month}>
                                                <h4 className="crimson font-bold text-lg text-[#9b7e46] mb-3 border-b border-[#dcd9d0]/50 pb-1 inline-block">{month}</h4>
                                                <ul className="space-y-2">
                                                    {booksInMonth.map(book => (
                                                        <li key={book.id}>
                                                            <a href={`#book-${book.id}`} onClick={(e) => { e.preventDefault(); document.getElementById(`book-${book.id}`)?.scrollIntoView({ behavior: 'smooth' }); }} className="text-sm text-gray-700 hover:text-[#1a1a1a] hover:underline decoration-[#9b7e46]/30 underline-offset-2 transition-all block">
                                                                {book.title}
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                        )}

                        {errorMessage && (
                            <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-8 flex gap-3 shadow-sm rounded-sm items-start text-red-800">
                                <Icon name="alert-triangle" className="mt-0.5" />
                                <div className="flex-1 font-bold text-sm">{errorMessage}</div>
                                <button onClick={() => setErrorMessage(null)} className="text-red-400 hover:text-red-600"><Icon name="x" size={16}/></button>
                            </div>
                        )}

                        {/* ADD ENTRY (HIDDEN IF READ ONLY) */}
                        {!isReadOnly && (
                            <div className="mb-12 flex justify-center">
                                {!isAddOpen ? (
                                    <button onClick={() => setIsAddOpen(true)} className="bg-[#1a1a1a] text-white px-8 py-3 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                        <Icon name="plus" size={16} /> Log New Book
                                    </button>
                                ) : (
                                    <section className="w-full p-8 border border-[#dcd9d0] bg-white shadow-lg animate-fade-in relative">
                                        <button onClick={() => setIsAddOpen(false)} className="absolute top-4 right-4 text-gray-300 hover:text-black"><Icon name="x" /></button>
                                        <div className="flex items-center gap-2 mb-6 text-[#9b7e46]"><Icon name="book-plus" size={20}/><h3 className="crimson font-bold uppercase text-xs tracking-widest">New Entry</h3></div>
                                        <form onSubmit={handleAddBook} className="space-y-6">
                                            <div className="flex justify-center mb-6">
                                                <div className="bg-[#fdfaf3] p-1 rounded-full border border-[#dcd9d0] flex">
                                                    <button type="button" onClick={() => setNewBook({...newBook, status: 'finished'})} className={`px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors ${newBook.status === 'finished' ? 'bg-[#1a1a1a] text-white' : 'text-gray-400 hover:text-black'}`}>Finished</button>
                                                    <button type="button" onClick={() => setNewBook({...newBook, status: 'reading'})} className={`px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors ${newBook.status === 'reading' ? 'bg-[#9b7e46] text-white' : 'text-gray-400 hover:text-black'}`}>Currently Reading</button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <input type="text" placeholder="Title" className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 text-sm focus:border-[#9b7e46] outline-none transition-colors" value={newBook.title} onChange={e => setNewBook({...newBook, title: e.target.value})} required />
                                                <input type="text" placeholder="Author" className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 text-sm focus:border-[#9b7e46] outline-none transition-colors" value={newBook.author} onChange={e => setNewBook({...newBook, author: e.target.value})} required />
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div><label className="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-2">Classification</label><select className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 text-sm outline-none cursor-pointer" value={newBook.classification} onChange={e => setNewBook({...newBook, classification: e.target.value})}>{BOOK_CLASSIFICATIONS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                                {newBook.status === 'finished' && (
                                                    <div className="animate-fade-in"><label className="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-2">Month Completed</label><select className="w-full bg-[#fdfaf3] border border-[#dcd9d0] p-3 text-sm outline-none cursor-pointer" value={newBook.monthFinished} onChange={e => setNewBook({...newBook, monthFinished: e.target.value})}>{MONTHS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                                )}
                                            </div>
                                            <div className="flex items-center justify-between pt-2">
                                                {newBook.status === 'finished' ? (<div className="flex items-center gap-3 animate-fade-in">{[1,2,3,4,5].map(s => (<button type="button" key={s} onClick={() => setNewBook({...newBook, rating: s})}><Icon name="star" size={24} fill={s <= newBook.rating ? "#9b7e46" : "none"} className={s <= newBook.rating ? "text-[#9b7e46]" : "text-[#dcd9d0] hover:text-[#9b7e46]"} /></button>))}</div>) : <div></div>}
                                                <button type="submit" className="bg-[#1a1a1a] text-white px-8 py-3 text-xs font-bold uppercase tracking-widest hover:bg-[#9b7e46] transition-colors flex items-center justify-center gap-2 rounded-sm">
                                                    {newBook.status === 'reading' ? <><Icon name="book-open" size={14} /> Add to Shelf</> : <><Icon name="sparkles" size={14} /> Start Reflection</>}
                                                </button>
                                            </div>
                                        </form>
                                    </section>
                                )}
                            </div>
                        )}

                        {/* LIST */}
                        <div className="space-y-12">
                            {loading ? (
                                <div className="flex flex-col items-center py-20 text-gray-400"><Icon name="rotate-cw" className="animate-spin mb-4" /><p className="crimson italic">Consulting the project archive...</p></div>
                            ) : filteredFinishedBooks.length > 0 ? filteredFinishedBooks.map((book, idx) => (
                                <div key={book.id} id={`book-${book.id}`} className="scroll-mt-20">
                                    {editingId === book.id && !isReadOnly ? (
                                        <div className="p-8 border-2 border-[#9b7e46] bg-white shadow-xl animate-fade-in">
                                            {/* EDIT FORM (Simplified for brevity - assumes same structure as your original, just wrapped in !isReadOnly logic already checked) */}
                                            <h3 className="crimson text-xl font-bold uppercase mb-6 flex justify-between items-center">Edit Entry <button onClick={() => setEditingId(null)} className="text-gray-400 hover:text-black"><Icon name="x" /></button></h3>
                                            <form onSubmit={handleUpdateEntry} className="space-y-6">
                                                 <div className="flex justify-end"><select value={editingBook.status || 'finished'} onChange={e => setEditingBook({...editingBook, status: e.target.value})} className="text-[10px] font-bold uppercase tracking-widest bg-gray-100 p-2 rounded"><option value="finished">Finished</option><option value="reading">Currently Reading</option></select></div>
                                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Title</label><input className="w-full p-3 text-sm border border-[#dcd9d0] bg-white outline-none focus:border-[#9b7e46]" value={editingBook.title} onChange={e => setEditingBook({...editingBook, title: e.target.value})} /></div>
                                                    <div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Author</label><input className="w-full p-3 text-sm border border-[#dcd9d0] bg-white outline-none focus:border-[#9b7e46]" value={editingBook.author} onChange={e => setEditingBook({...editingBook, author: e.target.value})} /></div>
                                                 </div>
                                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                     <div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Classification</label><select className="w-full p-3 text-sm border border-[#dcd9d0] bg-white outline-none focus:border-[#9b7e46]" value={editingBook.classification || BOOK_CLASSIFICATIONS[0]} onChange={e => setEditingBook({...editingBook, classification: e.target.value})}>{BOOK_CLASSIFICATIONS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                                     {editingBook.status !== 'reading' && (<><div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Mood Tag</label><input className="w-full p-3 text-sm border border-[#dcd9d0] bg-white outline-none focus:border-[#9b7e46]" value={editingBook.tag || ''} onChange={e => setEditingBook({...editingBook, tag: e.target.value})} /></div><div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Rating</label><div className="flex gap-1 pt-1">{[1,2,3,4,5].map(s => (<button type="button" key={s} onClick={() => setEditingBook({...editingBook, rating: s})}><Icon name="star" size={20} fill={s <= editingBook.rating ? "#9b7e46" : "none"} className={s <= editingBook.rating ? "text-[#9b7e46]" : "text-[#dcd9d0]"} /></button>))}</div></div></>)}
                                                 </div>
                                                 {editingBook.status !== 'reading' && (<div><label className="text-[10px] font-bold uppercase text-gray-400 block mb-1">Reflection</label><textarea rows={10} className="w-full p-4 text-sm border border-[#dcd9d0] bg-white outline-none focus:border-[#9b7e46] crimson italic custom-scrollbar" value={editingBook.review || ''} onChange={e => setEditingBook({...editingBook, review: e.target.value})} /></div>)}
                                                 <div className="flex gap-4"><button type="submit" className="flex-1 bg-[#1a1a1a] text-white py-3 font-bold uppercase text-xs tracking-widest hover:bg-[#9b7e46] transition-all flex items-center justify-center gap-2"><Icon name="save" size={16} /> Save Changes</button><button type="button" onClick={() => setEditingId(null)} className="px-6 py-3 border border-[#dcd9d0] text-xs font-bold uppercase hover:bg-gray-50">Cancel</button></div>
                                            </form>
                                        </div>
                                    ) : (
                                        <div className="p-8 md:p-12 border border-[#dcd9d0] bg-white relative transition-all group hover:shadow-lg">
                                            <div className="flex gap-6">
                                                {!searchTerm && !isReadOnly && (
                                                    <div className="hidden md:flex flex-col items-center gap-1 pt-1">
                                                        <button onClick={() => moveUp(idx)} className={`p-1 transition-colors ${idx === 0 ? 'text-gray-100 pointer-events-none' : 'text-gray-300 hover:text-[#9b7e46]'}`}><Icon name="arrow-up" size={14}/></button>
                                                        <div className="text-gray-200 cursor-default"><Icon name="grip-vertical" size={20} /></div>
                                                        <button onClick={() => moveDown(idx)} className={`p-1 transition-colors ${idx === filteredFinishedBooks.length - 1 ? 'text-gray-100 pointer-events-none' : 'text-gray-300 hover:text-[#9b7e46]'}`}><Icon name="arrow-down" size={14}/></button>
                                                    </div>
                                                )}
                                                <div className="flex-1 space-y-6">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="flex flex-wrap items-center gap-3 text-[11px] tracking-widest uppercase mb-2">
                                                                <span className="font-bold text-[#9b7e46]">{book.author}</span>
                                                                <span className="text-gray-300">/</span>
                                                                <span className="text-gray-400 italic">{book.classification || "Unclassified"}</span>
                                                            </div>
                                                            <h2 className="crimson text-4xl md:text-5xl font-bold text-[#1a1a1a] mb-3 leading-tight">{book.title}</h2>
                                                            <div className="flex flex-wrap items-center gap-4 text-[10px] uppercase font-bold text-gray-400 tracking-widest">
                                                                <span className="flex items-center gap-1"><Icon name="calendar" size={12}/> {book.monthFinished} {book.year}</span>
                                                                {book.tag && <span className="bg-[#f0ede4] text-[#5a5a5a] px-3 py-1 rounded-full">{book.tag}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-col items-end gap-2 shrink-0">
                                                            {!isReadOnly && (
                                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button onClick={() => { setEditingId(book.id); setEditingBook({...book, classification: book.classification || BOOK_CLASSIFICATIONS[0]}); }} className="text-gray-300 hover:text-[#9b7e46] transition-colors"><Icon name="edit-3" size={14} /></button>
                                                                    {deleteConfirmId === book.id ? (
                                                                        <button onClick={() => handleRemoveEntry(book.id)} className="bg-red-600 text-white px-2 py-0.5 text-[10px] uppercase rounded hover:bg-red-700">Delete?</button>
                                                                    ) : (
                                                                        <button onClick={() => setDeleteConfirmId(book.id)} className="text-gray-300 hover:text-red-600 transition-colors"><Icon name="trash-2" size={14} /></button>
                                                                    )}
                                                                </div>
                                                            )}
                                                            <div className="flex gap-0.5">{[1,2,3,4,5].map(s => <Icon key={s} name="star" size={12} fill={s <= book.rating ? "#9b7e46" : "none"} className={s <= book.rating ? "text-[#9b7e46]" : "text-[#dcd9d0]"} />)}</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-center pt-6 pb-2">
                                                        <div className="journal-frame group relative flex items-center justify-center bg-[#fdfaf3]">
                                                             {book.imageUrl ? (
                                                                <>
                                                                    <img src={book.imageUrl} alt="Visual" className="sketch-content" />
                                                                    {!isReadOnly && (
                                                                        <div className="absolute inset-0 bg-white/90 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                                                                            <button onClick={() => { setActiveBook({ id: book.id }); fileInputRef.current.click(); }} className="text-gray-500 hover:text-black text-xs font-bold uppercase tracking-widest flex items-center gap-2"><Icon name="upload" size={14} /> Upload Image</button>
                                                                            <button onClick={() => handleFetchCover(book)} disabled={generatingImageId === book.id} className="text-[#9b7e46] hover:text-black text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                                                                {generatingImageId === book.id ? <div className="animate-spin h-3 w-3 border border-black border-t-transparent rounded-full" /> : <Icon name="search" size={14} />} Fetch Cover
                                                                            </button>
                                                                            <button onClick={() => handleRevertCover(book)} className="text-gray-400 hover:text-black text-xs font-bold uppercase tracking-widest flex items-center gap-2 mt-2 pt-2 border-t border-gray-100 w-1/2 justify-center"><Icon name="undo" size={14} /> Revert</button>
                                                                        </div>
                                                                    )}
                                                                </>
                                                             ) : (
                                                                 <div className="w-[300px] h-[400px] flex flex-col items-center justify-center gap-4 bg-[#fdfaf3] border-dashed border border-gray-200">
                                                                      {!isReadOnly && <div className="flex gap-6"><button onClick={() => { setActiveBook({ id: book.id }); fileInputRef.current.click(); }} className="flex flex-col items-center gap-1 text-gray-300 hover:text-black transition-colors"><Icon name="upload" size={20} /><span className="text-[9px] uppercase font-bold tracking-widest">Upload Cover</span></button><div className="w-px bg-gray-200 h-8"></div><button onClick={() => handleFetchCover(book)} disabled={generatingImageId === book.id} className="flex flex-col items-center gap-1 text-gray-300 hover:text-[#9b7e46] transition-colors">{generatingImageId === book.id ? <div className="animate-spin h-5 w-5 border border-[#9b7e46] border-t-transparent rounded-full" /> : <Icon name="search" size={20} />}<span className="text-[9px] uppercase font-bold tracking-widest">Fetch Cover</span></button></div>}
                                                                 </div>
                                                             )}
                                                        </div>
                                                    </div>
                                                    <div className="prose max-w-none pt-2 border-t border-transparent">
                                                        <h4 className="crimson font-bold text-xs uppercase tracking-widest text-[#9b7e46] mb-4 inline-block border-b border-[#dcd9d0] pb-1">Reflections</h4>
                                                        <p className="crimson text-xl leading-relaxed text-gray-800 text-justify whitespace-pre-wrap">{book.review}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )) : (
                                <div className="text-center py-20 border border-dashed border-[#dcd9d0] text-gray-400">
                                    <Icon name="book-marked" size={48} className="mx-auto mb-4 opacity-20"/>
                                    {searchTerm ? <p className="crimson italic">No entries match "{searchTerm}"</p> : <p className="crimson italic">Library is currently empty.</p>}
                                </div>
                            )}
                        </div>
                        
                        <div className="mt-20 pt-8 border-t border-[#dcd9d0] text-center">
                             <button onClick={handleExportData} className="text-gray-400 hover:text-[#9b7e46] text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 mx-auto"><Icon name="download" size={14}/> Download Journal Data (JSON)</button>
                        </div>
                    </div>
                    
                    {!isReadOnly && <input type="file" ref={fileInputRef} onChange={onFileChange} accept="image/*" className="hidden" />}

                    {isInterviewOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#1a1a1a]/40 backdrop-blur-sm">
                            <div className="bg-[#fdfaf3] w-full max-w-xl border border-[#dcd9d0] shadow-2xl relative animate-fade-in">
                                <button onClick={() => setIsInterviewOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-black"><Icon name="x" size={20} /></button>
                                <div className="p-8 text-ink-black">
                                    <div className="flex items-center gap-3 mb-8"><div className="bg-[#9b7e46] text-white p-2 rounded-full"><Icon name="sparkles" size={20} /></div><div><h3 className="crimson text-xl font-bold uppercase tracking-wider">Reflecting: {activeBook?.title}</h3><p className="text-[10px] font-bold uppercase text-gray-400">Anchor {currentQuestionIdx + 1} of {STANDARDIZED_QUESTIONS.length}</p></div></div>
                                    {isGenerating ? (<div className="space-y-4 py-8"><div className="h-4 shimmer w-full"></div><div className="h-4 shimmer w-5/6"></div><div className="h-4 shimmer w-4/6"></div><p className="crimson italic text-center text-gray-400 mt-4">Writing reflections...</p></div>) : (
                                        <div className="space-y-6">
                                            <p className="crimson text-xl italic text-gray-700 leading-relaxed">"{STANDARDIZED_QUESTIONS[currentQuestionIdx]}"</p>
                                            <textarea autoFocus className="w-full bg-white border border-[#dcd9d0] p-4 focus:border-[#9b7e46] outline-none resize-none crimson text-lg custom-scrollbar" rows={4} placeholder="Your thoughts..." value={answers[currentQuestionIdx] || ''} onChange={(e) => setAnswers({...answers, [currentQuestionIdx]: e.target.value})} />
                                            <div className="flex justify-between items-center">
                                                <button disabled={currentQuestionIdx === 0} onClick={() => setCurrentQuestionIdx(prev => prev - 1)} className="text-xs font-bold uppercase text-gray-400 disabled:opacity-0 hover:text-black transition-colors">Back</button>
                                                {currentQuestionIdx < STANDARDIZED_QUESTIONS.length - 1 ? (<button onClick={() => setCurrentQuestionIdx(prev => prev + 1)} className="bg-[#1a1a1a] text-white px-6 py-2 text-xs font-bold uppercase hover:bg-[#9b7e46] flex items-center gap-2 transition-colors">Next <Icon name="send" size={14}/></button>) : (<button onClick={finalizeReview} className="bg-[#9b7e46] text-white px-8 py-3 text-xs font-bold uppercase hover:bg-[#1a1a1a] flex items-center gap-2 transition-colors">Finalize <Icon name="sparkles" size={14}/></button>)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- ROOT WRAPPER ---
        function App() {
            const [urlParams, setUrlParams] = useState(null);
            const [db, setDb] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const initApp = async () => {
                    try {
                        const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged } = window.FirebaseSDK;
                        const app = initializeApp(MY_FIREBASE_CONFIG);
                        const dbInstance = getFirestore(app);
                        const authInstance = getAuth(app);
                        setDb(dbInstance);

                        // Ensure we have a user BEFORE doing anything else
                        try {
                            await signInAnonymously(authInstance);
                        } catch (e) {
                            console.error("Auth Failed", e);
                            setAuthError(e.message);
                            return; 
                        }

                        onAuthStateChanged(authInstance, (u) => {
                            setCurrentUser(u);
                        });
                    } catch (err) {
                        setAuthError("Failed to initialize app.");
                    }
                };
                initApp();
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const user = params.get("user");
                const key = params.get("key");
                if (user) {
                    setUrlParams({ user, key });
                } else {
                    setUrlParams(null);
                }
            }, []);

            const handleEnter = (handle, key) => {
                const url = new URL(window.location);
                url.searchParams.set("user", handle);
                if(key) url.searchParams.set("key", key);
                window.history.pushState({}, "", url);
                setUrlParams({ user: handle, key });
            };

            if (authError) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-red-50 border border-red-200 text-red-800 p-6 rounded shadow-lg max-w-md text-center">
                            <h2 className="font-bold mb-2">Connection Error</h2>
                            <p className="text-sm">{authError}</p>
                            <p className="text-xs mt-4 text-gray-500">Please refresh the page or try again later.</p>
                        </div>
                    </div>
                );
            }

            // Show a global loading state until Firebase is ready
            if (!db || !currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="flex flex-col items-center gap-4 text-gray-400 animate-pulse">
                            <Icon name="rotate-cw" className="animate-spin" size={24} />
                            <p className="text-xs uppercase tracking-widest font-bold">Connecting to Library...</p>
                        </div>
                    </div>
                );
            }

            if (!urlParams) {
                return <LandingPage onEnter={handleEnter} db={db} />;
            }

            return <JournalApp userHandle={urlParams.user} secretKey={urlParams.key} db={db} currentUser={currentUser} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>